<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>PMFS Web Interface</title>
</head>
<body>
<h1>PMFS Web Interface</h1>

<section>
  <h2>Products</h2>
  <select id="products"></select>
  <button onclick="loadProducts()">Refresh</button>
</section>

<section>
  <h2>Projects</h2>
  <select id="projects" onchange="loadRequirements()"></select>
  <button onclick="loadProjects()">Refresh</button>
</section>

<section>
  <h2>Requirements</h2>
  <select id="requirements"></select>
  <input type="file" id="fileInput" />
  <button onclick="uploadAttachment()">Upload</button>
  <div>
    <button onclick="exportProject('excel')">Export Excel</button>
    <button onclick="exportProject('csv')">Export CSV</button>
    <button onclick="exportProject('struct')">Export Struct</button>
  </div>
  <div>
    <input type="file" id="excelImport" />
    <button onclick="importExcel()">Import Excel</button>
  </div>
  <pre id="reqs"></pre>
</section>

<script>
async function loadProducts(){
  const res = await fetch('/products', {headers:{'X-Role':'viewer'}});
  const data = await res.json();
  const sel = document.getElementById('products');
  sel.innerHTML = '';
  data.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = p.name;
    sel.appendChild(opt);
  });
  if(data.length){
    sel.value = data[0].id;
    await loadProjects();
  }
}

async function loadProjects(){
  const prod = document.getElementById('products').value;
  const res = await fetch(`/products/${prod}/projects`, {headers:{'X-Role':'viewer'}});
  const data = await res.json();
  const sel = document.getElementById('projects');
  sel.innerHTML = '';
  data.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = p.name;
    sel.appendChild(opt);
  });
  if(data.length){
    sel.value = data[0].id;
    await loadRequirements();
  } else {
    document.getElementById('reqs').textContent = '';
  }
}

async function loadRequirements(){
  const pid = document.getElementById('projects').value;
  if(!pid){
    document.getElementById('reqs').textContent = '';
    document.getElementById('requirements').innerHTML = '';
    return;
  }
  const res = await fetch(`/projects/${pid}/struct`, {headers:{'X-Role':'viewer'}});
  const data = await res.json();
  const sel = document.getElementById('requirements');
  sel.innerHTML = '';
  data.requirements.forEach(r => {
    const opt = document.createElement('option');
    opt.value = r.id;
    opt.textContent = r.name || r.description || `Requirement ${r.id}`;
    sel.appendChild(opt);
  });
  document.getElementById('reqs').textContent = JSON.stringify({requirements: data.requirements, attachments: data.attachments}, null, 2);
}

async function uploadAttachment(){
  const rid = document.getElementById('requirements').value;
  const fileInput = document.getElementById('fileInput');
  if(!rid || fileInput.files.length === 0){
    return;
  }
  const form = new FormData();
  form.append('file', fileInput.files[0]);
  const res = await fetch(`/requirements/${rid}/attachments`, {method:'POST', headers:{'X-Role':'editor'}, body: form});
  if(res.ok){
    fileInput.value = '';
    await loadRequirements();
  } else {
    const msg = await res.text();
    alert(msg);
  }
}

async function exportProject(type){
  const pid = document.getElementById('projects').value;
  if(!pid){
    return;
  }
  const res = await fetch(`/projects/${pid}/export/${type}`, {headers:{'X-Role':'viewer'}});
  if(res.ok){
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const name = type === 'excel' ? 'project.xlsx' : type === 'csv' ? 'project.csv' : 'project.json';
    a.download = name;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    await loadRequirements();
  } else {
    const msg = await res.text();
    alert(msg);
  }
}

async function importExcel(){
  const pid = document.getElementById('projects').value;
  const input = document.getElementById('excelImport');
  if(!pid || input.files.length === 0){
    return;
  }
  const form = new FormData();
  form.append('file', input.files[0]);
  const res = await fetch(`/projects/${pid}/import/excel`, {method:'POST', headers:{'X-Role':'editor'}, body: form});
  if(res.ok){
    input.value = '';
    await loadRequirements();
  } else {
    const msg = await res.text();
    alert(msg);
  }
}

loadProducts();
</script>
</body>
</html>
