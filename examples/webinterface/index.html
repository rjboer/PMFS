<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>PMFS Web Interface</title>
</head>
<body>
<h1>PMFS Web Interface</h1>

<section>
  <h2>Products</h2>
  <select id="products"></select>
  <button onclick="loadProducts()">Refresh</button>
</section>

<section>
  <h2>Projects</h2>
  <select id="projects" onchange="loadRequirements()"></select>
  <button onclick="loadProjects()">Refresh</button>
</section>

<section>
  <h2>Requirements</h2>
  <select id="requirements"></select>
  <input type="file" id="fileInput" />
  <button onclick="uploadAttachment()">Upload</button>

  <div>
    <button onclick="exportProject('excel')">Export Excel</button>
    <button onclick="exportProject('csv')">Export CSV</button>
    <button onclick="exportProject('struct')">Export Struct</button>
  </div>
  <div>
    <input type="file" id="excelImport" />
    <button onclick="importExcel()">Import Excel</button>
  </div>
  <pre id="reqs"></pre>

</section>

<script>
async function loadProducts(){
  const res = await fetch('/products', {headers:{'X-Role':'viewer'}});
  const data = await res.json();
  const sel = document.getElementById('products');
  sel.innerHTML = '';
  data.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = p.name;
    sel.appendChild(opt);
  });
  if(data.length){
    sel.value = data[0].id;
    await loadProjects();
  }
}

async function loadProjects(){
  const prod = document.getElementById('products').value;
  const res = await fetch(`/products/${prod}/projects`, {headers:{'X-Role':'viewer'}});
  const data = await res.json();
  const sel = document.getElementById('projects');
  sel.innerHTML = '';
  data.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = p.name;
    sel.appendChild(opt);
  });
  if(data.length){
    sel.value = data[0].id;
    await loadRequirements();
  } else {
  document.getElementById('reqs').innerHTML = '';
  }
}

async function loadRequirements(){
  const pid = document.getElementById('projects').value;
  if(!pid){
    document.getElementById('reqs').innerHTML = '';
    document.getElementById('requirements').innerHTML = '';
    return;
  }
  const res = await fetch(`/projects/${pid}/struct`, {headers:{'X-Role':'viewer'}});
  const data = await res.json();
  const sel = document.getElementById('requirements');
  sel.innerHTML = '';
  const reqsDiv = document.getElementById('reqs');
  reqsDiv.innerHTML = '';
  data.requirements.forEach(r => {
    const name = r.name || r.description || `Requirement ${r.id}`;

    const opt = document.createElement('option');
    opt.value = r.id;
    opt.textContent = name + (r.condition && r.condition.aianalyzed ? ' (analyzed)' : '');
    sel.appendChild(opt);

    const div = document.createElement('div');
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = r.condition && r.condition.active;
    checkbox.onchange = async () => {
      await fetch(`/projects/${pid}/requirements/${r.id}/active`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json', 'X-Role': 'editor'},
        body: JSON.stringify({active: checkbox.checked})
      });
    };
    div.appendChild(checkbox);
    const label = document.createElement('span');
    label.textContent = name + (r.condition && r.condition.aianalyzed ? ' (analyzed)' : '');
    div.appendChild(label);

    const analyzeBtn = document.createElement('button');
    analyzeBtn.textContent = 'Analyze';
    const result = document.createElement('span');
    result.style.marginLeft = '10px';
    analyzeBtn.onclick = async () => {
      await analyzeRequirement(r.id, result, label);
    };
    div.appendChild(analyzeBtn);
    div.appendChild(result);
    reqsDiv.appendChild(div);
  });
}

async function analyzeRequirement(rid, resultEl, labelEl){
  const res = await fetch(`/requirements/${rid}/analyze`, {method:'POST', headers:{'X-Role':'editor'}});
  if(res.ok){
    const data = await res.json();
    resultEl.textContent = `${data.pass ? 'Pass' : 'Fail'}: ${data.answer}`;
    if(!labelEl.textContent.includes('(analyzed)')){
      labelEl.textContent += ' (analyzed)';
    }
    const sel = document.getElementById('requirements');
    for(const opt of sel.options){
      if(opt.value == rid){
        if(!opt.textContent.includes('(analyzed)')){
          opt.textContent += ' (analyzed)';
        }
        break;
      }
    }
  } else {
    const msg = await res.text();
    resultEl.textContent = `Error: ${msg}`;
  }
}

async function uploadAttachment(){
  const rid = document.getElementById('requirements').value;
  const fileInput = document.getElementById('fileInput');
  if(!rid || fileInput.files.length === 0){
    return;
  }
  const form = new FormData();
  form.append('file', fileInput.files[0]);
  const res = await fetch(`/requirements/${rid}/attachments`, {method:'POST', headers:{'X-Role':'editor'}, body: form});
  if(res.ok){
    fileInput.value = '';
    await loadRequirements();
  } else {
    const msg = await res.text();
    alert(msg);
  }
}

async function exportProject(type){
  const pid = document.getElementById('projects').value;
  if(!pid){
    return;
  }
  const res = await fetch(`/projects/${pid}/export/${type}`, {headers:{'X-Role':'viewer'}});
  if(res.ok){
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const name = type === 'excel' ? 'project.xlsx' : type === 'csv' ? 'project.csv' : 'project.json';
    a.download = name;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    await loadRequirements();
  } else {
    const msg = await res.text();
    alert(msg);
  }
}

async function importExcel(){
  const pid = document.getElementById('projects').value;
  const input = document.getElementById('excelImport');
  if(!pid || input.files.length === 0){
    return;
  }
  const form = new FormData();
  form.append('file', input.files[0]);
  const res = await fetch(`/projects/${pid}/import/excel`, {method:'POST', headers:{'X-Role':'editor'}, body: form});
  if(res.ok){
    input.value = '';
    await loadRequirements();
  } else {
    const msg = await res.text();
    alert(msg);
  }
}

loadProducts();
</script>
</body>
</html>
