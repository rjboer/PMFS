<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>PMFS Web Interface</title>
</head>
<body>
<h1>PMFS Web Interface</h1>

<section>
  <h2>Products</h2>
  <select id="products"></select>
  <button onclick="loadProducts()">Refresh</button>
</section>

<section>
  <h2>Projects</h2>
  <select id="projects" onchange="changeProject()"></select>
  <button onclick="loadProjects()">Refresh</button>
</section>

<section>
  <h2>Requirements</h2>
  <select id="requirements"></select>
  <input type="file" id="fileInput" />
  <button onclick="uploadAttachment()">Upload</button>

  <div>
    <button onclick="exportProject('excel')">Export Excel</button>
    <button onclick="exportProject('csv')">Export CSV</button>
    <button onclick="exportProject('struct')">Export Struct</button>
  </div>

  <div>
    <input type="file" id="excelImport" />
    <button onclick="importExcel()">Import Excel</button>
  </div>
  <div>
    <label for="statusFilter">Status:</label>
    <select id="statusFilter" onchange="resetPageAndLoad()">
      <option value="">All</option>
      <option value="active">Active</option>
      <option value="proposed">Proposed</option>
      <option value="deleted">Deleted</option>
    </select>
    <button id="prevPage" onclick="changePage(-1)">Prev</button>
    <span id="pageNumber"></span>
    <button id="nextPage" onclick="changePage(1)">Next</button>
  </div>
  <table border="1">
    <thead>
      <tr><th>ID</th><th>Text</th><th>Status</th><th>Attachments</th></tr>
    </thead>
    <tbody id="reqs"></tbody>
  </table>

</section>

<script>
let currentPage = 1;
const pageSize = 10;
let evtSource = null;

async function loadProducts(){
  const res = await fetch('/products', {headers:{'X-Role':'viewer'}});
  const data = await res.json();
  const sel = document.getElementById('products');
  sel.innerHTML = '';
  data.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = p.name;
    sel.appendChild(opt);
  });
  if(data.length){
    sel.value = data[0].id;
    await loadProjects();
  }
}

async function loadProjects(){
  const prod = document.getElementById('products').value;
  const res = await fetch(`/products/${prod}/projects`, {headers:{'X-Role':'viewer'}});
  const data = await res.json();
  const sel = document.getElementById('projects');
  sel.innerHTML = '';
  data.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = p.name;
    sel.appendChild(opt);
  });
  if(data.length){
    sel.value = data[0].id;
    await changeProject();
  } else {
  document.getElementById('reqs').innerHTML = '';
  }
}

async function changeProject(){
  currentPage = 1;
  await loadRequirements();
  subscribeToProject();
}

async function resetPageAndLoad(){
  currentPage = 1;
  await loadRequirements();
}

function changePage(delta){
  currentPage += delta;
  if(currentPage < 1) currentPage = 1;
  loadRequirements();
}

function subscribeToProject(){
  if(evtSource){
    evtSource.close();
  }
  const pid = document.getElementById('projects').value;
  if(!pid) return;
  evtSource = new EventSource(`/projects/${pid}/struct/subscribe`);
  evtSource.addEventListener('update', () => {
    loadRequirements();
  });
}

async function loadRequirements(){
  const pid = document.getElementById('projects').value;
  if(!pid){
    document.getElementById('reqs').innerHTML = '';
    document.getElementById('requirements').innerHTML = '';
    return;
  }
  const status = document.getElementById('statusFilter').value;
  const res = await fetch(`/projects/${pid}/struct?status=${status}&page=${currentPage}&page_size=${pageSize}`, {headers:{'X-Role':'viewer'}});
  const data = await res.json();
  const sel = document.getElementById('requirements');
  sel.innerHTML = '';
  const reqsBody = document.getElementById('reqs');
  reqsBody.innerHTML = '';
  data.requirements.forEach(r => {
    const opt = document.createElement('option');
    opt.value = r.id;
    opt.textContent = r.name || r.description || `Requirement ${r.id}`;
    sel.appendChild(opt);


    const tr = document.createElement('tr');
    const tdId = document.createElement('td');
    tdId.textContent = r.id;
    tr.appendChild(tdId);
    const tdText = document.createElement('td');
    tdText.textContent = r.name || r.description || `Requirement ${r.id}`;
    tr.appendChild(tdText);
    const status = r.condition && r.condition.deleted ? 'deleted' : r.condition && r.condition.active ? 'active' : r.condition && r.condition.proposed ? 'proposed' : '';
    const tdStatus = document.createElement('td');
    tdStatus.textContent = status;
    tr.appendChild(tdStatus);
    const attCount = typeof r.attachment_index === 'number' && r.attachment_index >= 0 ? 1 : 0;
    const tdAtt = document.createElement('td');
    tdAtt.textContent = attCount;
    tr.appendChild(tdAtt);
    reqsBody.appendChild(tr);

  });
  document.getElementById('pageNumber').textContent = `Page ${currentPage}`;
  document.getElementById('prevPage').disabled = currentPage <= 1;
  document.getElementById('nextPage').disabled = data.requirements.length < pageSize;
}

async function uploadAttachment(){
  const rid = document.getElementById('requirements').value;
  const fileInput = document.getElementById('fileInput');
  if(!rid || fileInput.files.length === 0){
    return;
  }
  const form = new FormData();
  form.append('file', fileInput.files[0]);
  const res = await fetch(`/requirements/${rid}/attachments`, {method:'POST', headers:{'X-Role':'editor'}, body: form});
  if(res.ok){
    fileInput.value = '';
    await loadRequirements();
  } else {
    const msg = await res.text();
    alert(msg);
  }
}

async function exportProject(type){
  const pid = document.getElementById('projects').value;
  if(!pid){
    return;
  }
  const res = await fetch(`/projects/${pid}/export/${type}`, {headers:{'X-Role':'viewer'}});
  if(res.ok){
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const name = type === 'excel' ? 'project.xlsx' : type === 'csv' ? 'project.csv' : 'project.json';
    a.download = name;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    await loadRequirements();
  } else {
    const msg = await res.text();
    alert(msg);
  }
}

async function importExcel(event){
  event.preventDefault();
  const pid = document.getElementById('projects').value;
  const input = document.getElementById('excelImport');
  if(!pid || input.files.length === 0){
    return;
  }
  const form = new FormData();
  form.append('file', input.files[0]);
  const res = await fetch(`/projects/${pid}/import/excel`, {method:'POST', headers:{'X-Role':'editor'}, body: form});
  if(res.ok){
    input.value = '';
    await loadRequirements();
  } else {
    const msg = await res.text();
    alert(msg);
  }
}

loadProducts();
</script>
</body>
</html>
